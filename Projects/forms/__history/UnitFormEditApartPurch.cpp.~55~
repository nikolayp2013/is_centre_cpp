//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UnitFormEditApartPurch.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "DBLookupComboBoxCentre"
#pragma link "my_DBCtrls"
#pragma resource "*.dfm"
TFormEditApartPurch *FormEditApartPurch;
TIBDatabase * MainConn = NULL;
extern TIBDatabase * MainConn;
TIBTransaction * MainTransaction = NULL;
extern TIBTransaction * MainTransaction;
// Таблица со списком элементов
TIBTable * Table_Items = NULL;
extern TIBTable * Table_Items;
// Таблица со списком клиентов
TIBTable * Table_Clients = NULL;
extern TIBTable * Table_Clients;
TDataSource * Clients_Datasource =NULL;
extern TDataSource * Clients_Datasource;
// Таблица со списком категорий клиента
TIBTable * Table_Clients_kategory1 = NULL;
extern TIBTable * Table_Clients_kategory1;
TIBTable * Table_Clients_kategory2 = NULL;
extern TIBTable * Table_Clients_kategory2;
TDataSource * Clients_Datasource_kategory =NULL;
extern TDataSource * Clients_Datasource_kategory;
// Для агента
TIBTransaction * TransactionAgent = NULL;
extern TIBTransaction * TransactionAgent;
// Таблица со списком агентов
TIBTable * Table_Agent = NULL;
extern TIBTable * Table_Agent;
TDataSource * Agent_datasource = NULL;
extern TDataSource * Agent_datasource;
TIBTransaction * OtherTransaction = NULL;
extern TIBTransaction * OtherTransaction;
//---------------------------------------------------------------------------
__fastcall TFormEditApartPurch::TFormEditApartPurch(TComponent* Owner)
	: TForm(Owner)
{
    OtherTransaction = new TIBTransaction(NULL);
	OtherTransaction->DefaultDatabase = MainForm->MainConn;

	//Создать табличку со списко клиентов
	Table_Clients = new TIBTable(NULL);
	Table_Clients->Database=MainForm->MainConn;
	Table_Clients->Transaction=OtherTransaction;
	Table_Clients->TableName = "CLIENTS";
	Table_Clients->Filter = "COMPID=";
	char * tmpint = new char[17];
	itoa(OwnerCode,tmpint,10);
	Table_Clients->Filter = Table_Clients->Filter+tmpint;
	delete tmpint;
	Table_Clients->Filtered = true;
	Table_Clients->Active=true;
	Table_Clients->FetchAll();

	//Создать табличку со списком категорий клиентов
	Table_Clients_kategory1 = new TIBTable(NULL);
	Table_Clients_kategory1->Database=MainForm->MainConn;
	Table_Clients_kategory1->Transaction=OtherTransaction;
	Table_Clients_kategory1->TableName = "ITEMS";
	Table_Clients_kategory1->Filter = "RAZDEL=15 and MGROUP=0";
	Table_Clients_kategory1->Filtered = true;
	Table_Clients_kategory1->Active=true;
	Table_Clients_kategory1->FetchAll();
	Table_Clients_kategory1->Edit();

	//Создать табличку со списком категорий клиентов для юр. лица
	Table_Clients_kategory2 = new TIBTable(NULL);
	Table_Clients_kategory2->Database=MainForm->MainConn;
	Table_Clients_kategory2->Transaction=OtherTransaction;
	Table_Clients_kategory2->TableName = "ITEMS";
	Table_Clients_kategory2->Filter = "RAZDEL=15 and MGROUP=1";
	Table_Clients_kategory2->Filtered = true;
	Table_Clients_kategory2->Active=true;
	Table_Clients_kategory2->FetchAll();
	Table_Clients_kategory2->Edit();

	//Создать объект DataSource для таблицы категорий клиентов
	Clients_Datasource_kategory = new TDataSource(NULL);

	//Создать объект DataSource для таблицы клиентов
	Clients_Datasource = new TDataSource(NULL);
	Clients_Datasource->DataSet=Table_Clients;

	// Вызов процедуры обновления сведений о клиенте
	ProcRefreshClient(this);

	//Для агента
	TransactionAgent = new TIBTransaction(NULL);
	TransactionAgent->DefaultDatabase = MainForm->MainConn;

    //Таблица со списком агентов
	Table_Agent = new TIBTable(NULL);
	Table_Agent->Database=MainForm->MainConn;
	Table_Agent->Transaction=TransactionAgent;
	Table_Agent->TableName = "PEOPLE";
	Table_Agent->Active = true;
	Table_Agent->FetchAll();
	Agent_datasource = new TDataSource(NULL);

	//Цикл по всем записям таблицы
	 Table_Agent->First();
	 do {
		Agent_ComboBox->Items->Add(Table_Agent->FieldByName("FULLNAME")->AsString);
		Table_Agent->Next();
	 } while(!Table_Agent->Eof);
	 Table_Agent->First();

	Agent_datasource->DataSet=Table_Agent;
	Agent_datasource->DataSet->Active=false;
	if (!(MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->IsNull ||
		MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->AsInteger==0)) {
		Agent_datasource->DataSet->Active=True;
		Agent_datasource->DataSet->First();
		if (Agent_datasource->DataSet->Locate("ID",MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->AsInteger,TLocateOptions())) {
			 Agent_ComboBox->ItemIndex = Agent_datasource->DataSet->RecNo-1;
		} else {
		}
	} else {
	}
	if (Agent_datasource->DataSet->Active) {
		Agent_datasource->DataSet->FieldByName("MAINPHONE")->EditMask="000\-00\-00;1;_";
		Agent_datasource->DataSet->FieldByName("ADDPHONE")->EditMask="000\-00\-00;1;_";
	}



	//Создать табличку со списко элементов
	Table_Items = new TIBTable(NULL);
	Table_Items->Database=MainForm->MainConn;
	Table_Items->Transaction=OtherTransaction;
	Table_Items->TableName = "ITEMS";
	Table_Items->Filter = "Razdel=8";
	Table_Items->Filtered = true;
	Table_Items->Active=true;
	Table_Items->FetchAll();

	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==1) {
		Flow_1_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==2) {
		Flow_2_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==3) {
		Flow_3_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==4) {
		Flow_4_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==5) {
		Flow_5_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==6) {
		Flow_6_RadioButton->Checked = true;
	}
	if (MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("LEVEL")->AsInteger==7) {
		Flow_7_RadioButton->Checked = true;
	}
}
//---------------------------------------------------------------------------
void __fastcall TFormEditApartPurch::ProcRefreshClient(TObject *Sender)
{
	Clients_Datasource->DataSet->Active=true;
	Clients_Datasource->DataSet->Edit();
	MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
	if (!(MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->IsNull||
		MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->AsInteger==0)&&
		Table_Clients->Locate("ID", MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->AsInteger,TLocateOptions())) {
		if (Table_Clients->FieldByName("FACE")->AsInteger==1) {
			Clients_Datasource_kategory->DataSet=Table_Clients_kategory1;
		} else {
			Clients_Datasource_kategory->DataSet=Table_Clients_kategory2;
		}
		Clients_Datasource_kategory->DataSet->Active=TRUE;
		if (Clients_Datasource_kategory->DataSet->Locate("CODE",Table_Clients->FieldByName("KATID")->AsInteger,TLocateOptions())) {
			ClientKatid_Edit->Text = Clients_Datasource_kategory->DataSet->FieldByName("FULLNAME")->AsString;
		} else {
			ClientKatid_Edit->Text = "";
		}
	} else {
		//MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
		MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->AsInteger=0;
		ClientKatid_Edit->Text = "";
		Clients_Datasource->DataSet->Active=false;
	}
}
//---------------------------------------------------------------------------
void __fastcall TFormEditApartPurch::BitBtn1Click(TObject *Sender)
{
	// Кнопка сохранить изменения

	//Фиксация изменений
	MainForm->TabPricelist_Datasource_Main->DataSet->CheckBrowseMode();
	//Записать изменения в базу данных
	MainTransaction->CommitRetaining();
	//Открыть набор данных
	Close();
}
//---------------------------------------------------------------------------


void __fastcall TFormEditApartPurch::Flat_ButtonClick(TObject *Sender)
{
	// Кнопка выбрать "Квартиру"
	Table_Items->Active=false;
	Table_Items->Filtered = false;
	Table_Items->Filter = "Razdel=56";
	Table_Items->Filtered = true;
	Table_Items->Active=true;
	Table_Items->FetchAll();

	UnicodeString * resultstr = new UnicodeString;
	*resultstr = MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("FLAT")->AsString;

	FormSelect = new TFormSelect(this, Table_Items, resultstr);
	FormSelect->ShowModal();
	MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("FLAT")->AsString = *resultstr;
	delete FormSelect;
	delete resultstr;
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Region_ButtonClick(TObject *Sender)
{
	// Кнопка выбрать район
	Table_Items->Active=false;
	Table_Items->Filtered = false;
	Table_Items->Filter = "Razdel=8";
	Table_Items->Filtered = true;
	Table_Items->Active=true;
	Table_Items->FetchAll();

	UnicodeString * resultstr = new UnicodeString;
	*resultstr = MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("REGION")->AsString;

	FormSelect = new TFormSelect(this, Table_Items, resultstr);
	FormSelect->ShowModal();
	MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("REGION")->AsString = *resultstr;
	delete FormSelect;
	delete resultstr;
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Button10Click(TObject *Sender)
{
	// Очистить поле "Квартира"
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("FLAT")->AsString = "";
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Typehouse_ButtonClick(TObject *Sender)
{
	// Кнопка выбрать характеристику дома
	Table_Items->Active=false;
	Table_Items->Filtered = false;
	Table_Items->Filter = "Razdel=9";
	Table_Items->Filtered = true;
	Table_Items->Active=true;
	Table_Items->FetchAll();

	UnicodeString * resultstr = new UnicodeString;
	*resultstr = MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("TYPEHOUSE")->AsString;

	FormSelect = new TFormSelect(this, Table_Items, resultstr);
	FormSelect->ShowModal();
	MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("TYPEHOUSE")->AsString = *resultstr;
	delete FormSelect;
	delete resultstr;
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Button11Click(TObject *Sender)
{
	// Очистить поле характеристика дома
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("TYPEHOUSE")->AsString = "";
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Stuffwall_ButtonClick(TObject *Sender)
{
	// Кнопка выбрать материал стен
	Table_Items->Active=false;
	Table_Items->Filtered = false;
	Table_Items->Filter = "Razdel=6";
	Table_Items->Filtered = true;
	Table_Items->Active=true;
	Table_Items->FetchAll();

	UnicodeString * resultstr = new UnicodeString;
	*resultstr = MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("STUFFWALL")->AsString;

	FormSelect = new TFormSelect(this, Table_Items, resultstr);
	FormSelect->ShowModal();
	MainForm->TabPricelist_Datasource_Main->DataSet->Edit();
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("STUFFWALL")->AsString = *resultstr;
	delete FormSelect;
	delete resultstr;
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Button12Click(TObject *Sender)
{
	 // Очистить поле материал стен
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("STUFFWALL")->AsString = "";
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Button13Click(TObject *Sender)
{
	// Очистить поле район
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("REGION")->AsString = "";
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::PageControl1DrawTab(TCustomTabControl *Control,
          int TabIndex, const TRect &Rect, bool Active)
{
	TPageControl *control = (TPageControl*)Control;
	//control->Canvas->Brush->Color = clRed; // НЕОБХОДИМЫЙ ЦВЕТ!!!
	control->Canvas->Font = control->Font;
	//control->Canvas->Font->Style = Active ? control->Canvas->Font->Style << fsBold : control->Canvas->Font->Style >> fsBold;

	AnsiString text = control->Pages[TabIndex]->Caption;
	int textWidth = control->Canvas->TextWidth(text);
	int textHeight = control->Canvas->TextHeight(text);
	int textTop = Rect.Top + (Rect.Height() - textHeight)/2;
	int textLeft = Rect.Left + (Rect.Width() - textWidth)/2;

	control->Canvas->FillRect(Rect);
	control->Canvas->TextOut(textLeft, textTop, text);
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::SpeedButton1Click(TObject *Sender)
{
	long * retval = new long;
	*retval = 0;
	FormKlients = new TFormKlients(MainForm, MainForm->MainConn, retval);
	FormKlients->ShowModal();
	if (*retval!=0) {
		 MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->AsInteger=*retval;
	}
	// Вызов процедуры обновления сведений о клиенте
	ProcRefreshClient(this);
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::SpeedButton3Click(TObject *Sender)
{
	 MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("CLIENT")->AsInteger=0;
	// Вызов процедуры обновления сведений о клиенте
	ProcRefreshClient(this);
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::RefreshAgent(TObject *Sender)
{
	// Обновление сведений об агенте
	Agent_datasource->DataSet->Active=false;
	if (!(MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->IsNull ||
		MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->AsInteger==0)) {
		Agent_datasource->DataSet->Active=True;
		Agent_datasource->DataSet->First();
		if (Agent_datasource->DataSet->Locate("ID",MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->AsInteger,TLocateOptions())) {
			 Agent_ComboBox->ItemIndex = Agent_datasource->DataSet->RecNo-1;
		} else {
			Agent_datasource->DataSet->Active=false;
		}
	} else {
		Agent_datasource->DataSet->Active=false;
	}
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Agent_ComboBoxClick(TObject *Sender)
{
	Agent_datasource->DataSet->Active=true;
	Agent_datasource->DataSet->First();
	Agent_datasource->DataSet->MoveBy(Agent_ComboBox->ItemIndex);
	MainForm->TabPricelist_Datasource_Main->DataSet->FieldByName("IDAGENT")->AsInteger=
		Agent_datasource->DataSet->FieldByName("ID")->AsInteger;
	RefreshAgent(this);
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::Button1Click(TObject *Sender)
{
	FormAgKartEdit = new TFormAgKartEdit(this,Agent_datasource,MainForm->MainConn,TransactionAgent);
	FormAgKartEdit->ShowModal();
	delete FormAgKartEdit;
}
//---------------------------------------------------------------------------

void __fastcall TFormEditApartPurch::BitBtn2Click(TObject *Sender)
{
	Close();
}
//---------------------------------------------------------------------------


