//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UnitFormGridColumn.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TFormGridColumn *FormGridColumn;
TIBDatabase * MainConn = NULL;
extern TIBDatabase * MainConn;
TIBTransaction * GridTransaction = NULL;
extern TIBTransaction * GridTransaction;
// Таблица со списком полей
TIBTable * Table_Fieldsdef = NULL;
extern TIBTable * Table_Fieldsdef;
TDataSource * 	Fieldsdef_datasource = NULL;
extern TDataSource * Fieldsdef_datasource;
//Путь к экзешнику
AnsiString sPath = ExtractFileDir(Application->ExeName);
TIniFile *Ini = new TIniFile(sPath+"\\Propfiles\\fieldsdef.ini");
int swsell;
extern int swsell;
int swview;
extern int swview;
UnicodeString tablename;
extern UnicodeString tablename;
UnicodeString strcaption;
extern UnicodeString strcaption;
//---------------------------------------------------------------------------
__fastcall TFormGridColumn::TFormGridColumn(TComponent* Owner, TIBDatabase * MainConn_local, int swsell_local, int swview_local,
		UnicodeString tablename_local)
	: TForm(Owner)
{
	MainConn = MainConn_local;

	//Создать объект транзакций
	GridTransaction = new TIBTransaction(NULL);
	GridTransaction->DefaultDatabase = MainConn;

	//Создать табличку со списком полей
	Table_Fieldsdef = new TIBTable(NULL);
	Table_Fieldsdef->Database=MainConn;
	Table_Fieldsdef->Transaction=GridTransaction;
	Table_Fieldsdef->TableName = "FIELDSDEF";
	Table_Fieldsdef->Filter = "TABLEID=2";
	Table_Fieldsdef->Filtered = true;
	Table_Fieldsdef->Active=true;
	Table_Fieldsdef->FetchAll();

	Fieldsdef_datasource = new TDataSource(NULL);
	Fieldsdef_datasource->DataSet=Table_Fieldsdef;
	Width_DBEdit->DataSource = Fieldsdef_datasource;
	Width_DBEdit->DataField = "MANWIDTH";

	//Цикл по всем записям таблицы
	 Table_Fieldsdef->First();
	 do {
		Fields_CheckListBox->Items->Add(Table_Fieldsdef->FieldByName("CAPTFULL")->AsString);

		if (Ini->ReadString(tablename+"_check_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"0")==1)
			Fields_CheckListBox->Checked[Table_Fieldsdef->RecNo-1] = true;
		Table_Fieldsdef->Edit();
		Table_Fieldsdef->FieldByName("MANWIDTH")->AsString =
			Ini->ReadString(tablename+"_width_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"2");

		Table_Fieldsdef->Next();
	 } while(!Table_Fieldsdef->Eof);
	 Table_Fieldsdef->First();

	 Width_DBEdit->DataSource->DataSet->FieldByName("MANWIDTH")->Alignment=taLeftJustify;

	 strcaption="Настройка таблицы: ";
	 swsell = swsell_local;
	 swview = swview_local;
	 tablename=tablename_local;
	 if (AnsiUpperCase(tablename)=="APARTSELL") {
		 strcaption = strcaption + "Квартиры";
	 }
	 if (swview==1) {
		 strcaption = strcaption + ", Агентский вид";
	 }
	 if (swview==2) {
		 strcaption = strcaption + ", Клиентский вид";
	 }
	 if (swview==3) {
		 strcaption = strcaption + ", Вид ДСП";
	 }
	 //FormGridColumn->Caption = strcaption;
	 //ShowMessage(strcaption);
	 //ShowMessage(swsell);
	 //ShowMessage(swview);
	 //ShowMessage(tablename);
}
//---------------------------------------------------------------------------
void __fastcall TFormGridColumn::Fields_CheckListBoxClick(TObject *Sender)
{
	 Table_Fieldsdef->First();
	 Table_Fieldsdef->MoveBy(Fields_CheckListBox->ItemIndex);
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::Commit_ButtonClick(TObject *Sender)
{
	// Кнопка "Применить"
	int currno = Table_Fieldsdef->RecNo;
	//Цикл по всем записям таблицы
	 Table_Fieldsdef->First();
	 do {
		if (Fields_CheckListBox->Checked[Table_Fieldsdef->RecNo-1])
			Ini->WriteString(tablename+"_check_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"1");
		else Ini->WriteString(tablename+"_check_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"0");
		Ini->WriteString(tablename+"_width_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,
			Table_Fieldsdef->FieldByName("MANWIDTH")->AsString);

		Table_Fieldsdef->Next();
	 } while(!Table_Fieldsdef->Eof);
	 Table_Fieldsdef->RecNo = currno;
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::FormClose(TObject *Sender, TCloseAction &Action)

{
    GridTransaction->RollbackRetaining();
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::Button3Click(TObject *Sender)
{
    // Кнопка отмена
	Close();
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::Button2Click(TObject *Sender)
{
	// Кнопка ОК
	Commit_ButtonClick(this);
	Close();
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::Button1Click(TObject *Sender)
{
	// Кнопкам "По-умолчанию"
	int currno = Table_Fieldsdef->RecNo;
    //Цикл по всем записям таблицы
	 Table_Fieldsdef->First();
	 do {
		Table_Fieldsdef->Edit();
		Table_Fieldsdef->FieldByName("MANWIDTH")->AsInteger = Table_Fieldsdef->FieldByName("FIELDWIDTH")->AsInteger;
		Table_Fieldsdef->FieldByName("MANCHECK")->AsInteger = Table_Fieldsdef->FieldByName("FCHECK")->AsInteger;

		if (Table_Fieldsdef->FieldByName("FCHECK")->AsInteger==1){
			Fields_CheckListBox->Checked[Table_Fieldsdef->RecNo-1] = true;
			Ini->WriteString(tablename+"_check_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"1");
		} else {
			Fields_CheckListBox->Checked[Table_Fieldsdef->RecNo-1] = false;
			Ini->WriteString(tablename+"_check_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,"0");
        }

		Ini->WriteString(tablename+"_width_"+(UnicodeString)swsell+"_"+(UnicodeString)swview,Table_Fieldsdef->FieldByName("FIELDNAME")->AsString,
			Table_Fieldsdef->FieldByName("MANWIDTH")->AsString);

		Table_Fieldsdef->Next();
	 } while(!Table_Fieldsdef->Eof);
	 Table_Fieldsdef->RecNo=currno;
}
//---------------------------------------------------------------------------

void __fastcall TFormGridColumn::FormShow(TObject *Sender)
{
	FormGridColumn->Caption = strcaption;
}
//---------------------------------------------------------------------------

