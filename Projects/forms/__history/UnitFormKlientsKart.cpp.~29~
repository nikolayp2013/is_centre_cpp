//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UnitFormKlientsKart.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "DBLookupComboBoxCentre"
#pragma link "my_DBCtrls"
#pragma resource "*.dfm"
TFormKlientsKart *FormKlientsKart;
TIBDatabase * MainConn = NULL;
extern TIBDatabase * MainConn;
TIBTransaction * MainTransaction = NULL;
extern TIBTransaction * MainTransaction;
TIBTable * Table_Clients = NULL;
extern TIBTable * Table_Clients;
TDataSource * Clients_Datasource =NULL;
extern TDataSource * Clients_Datasource;
TIBTable * Table_Clients_kategory1 = NULL;
extern TIBTable * Table_Clients_kategory1;
TIBTable * Table_Clients_kategory2 = NULL;
extern TIBTable * Table_Clients_kategory2;
TDataSource * Clients_Datasource_kategory =NULL;
extern TDataSource * Clients_Datasource_kategory;
//---------------------------------------------------------------------------
__fastcall TFormKlientsKart::TFormKlientsKart(TComponent* Owner, TIBDatabase * MainConn_local,
	TIBTransaction * MainTransaction_local, TDataSource * Clients_Datasource_local)
	: TForm(Owner)
{
	MainConn = MainConn_local;
	//Создать объект транзакций
	MainTransaction = MainTransaction_local;

	//Создать объект DataSource для таблицы клиентов
	Clients_Datasource = Clients_Datasource_local;
	Clients_Datasource->DataSet->Active=TRUE;

	//Создать табличку со списком категорий клиентов
	Table_Clients_kategory1 = new TIBTable(NULL);
	Table_Clients_kategory1->Database=MainConn;
	Table_Clients_kategory1->Transaction=MainTransaction;
	Table_Clients_kategory1->TableName = "ITEMS";
	Table_Clients_kategory1->Filter = "RAZDEL=15 and MGROUP=0";
	Table_Clients_kategory1->Filtered = true;
	Table_Clients_kategory1->Active=true;
	Table_Clients_kategory1->FetchAll();

	//Создать табличку со списком категорий клиентов для юр. лица
	Table_Clients_kategory2 = new TIBTable(NULL);
	Table_Clients_kategory2->Database=MainConn;
	Table_Clients_kategory2->Transaction=MainTransaction;
	Table_Clients_kategory2->TableName = "ITEMS";
	Table_Clients_kategory2->Filter = "RAZDEL=15 and MGROUP=1";
	Table_Clients_kategory2->Filtered = true;
	Table_Clients_kategory2->Active=true;
	Table_Clients_kategory2->FetchAll();

	//Создать объект DataSource для таблицы категорий клиентов
	Clients_Datasource_kategory = new TDataSource(NULL);
	Clients_Datasource_kategory->DataSet=Table_Clients_kategory1;
	Clients_Datasource_kategory->DataSet->Active=TRUE;

	// ФИО
	Name_DBEdit->DataSource=Clients_Datasource;
	Name_DBEdit->DataField="NAME";

	// Категория клиента
	Katid_DBLookComb->ListSource=Clients_Datasource_kategory;
	Katid_DBLookComb->ListField="FULLNAME";
	Katid_DBLookComb->KeyField="CODE";
	Katid_DBLookComb->DataSource=Clients_Datasource;
	Katid_DBLookComb->DataField="KATID";

	// Фирма
	Comp_DBEdit->DataSource=Clients_Datasource;
	Comp_DBEdit->DataField="Comp";

	// Телефон
	Phone_DBEdit->DataSource=Clients_Datasource;
	Phone_DBEdit->DataField="PHONE";

	// Сотовый
	Mobile_DBEdit->DataSource=Clients_Datasource;
	Mobile_DBEdit->DataField="MOBILE";

	// Адрес
	House_DBEdit->DataSource=Clients_Datasource;
	House_DBEdit->DataField="HOUSE";

	// ICQ
	Pager_DBEdit->DataSource=Clients_Datasource;
	Pager_DBEdit->DataField="PAGER";

	// E-mail
	Operator_DBEdit->DataSource=Clients_Datasource;
	Operator_DBEdit->DataField="OPERATOR";

	// Комментарий
	Misc_DBMemo->DataSource=Clients_Datasource;
	Misc_DBMemo->DataField="MISC";

	// Действ. на основании
	Documents_DBEdit->DataSource=Clients_Datasource;
	Documents_DBEdit->DataField="DOCUMENTS";

	// Р/счет
	Rs_DBEdit->DataSource=Clients_Datasource;
	Rs_DBEdit->DataField="RS";

	// Банк
	Bank_DBMemo->DataSource=Clients_Datasource;
	Bank_DBMemo->DataField="BANK";

	// К/счет
	Ks_DBEdit->DataSource=Clients_Datasource;
	Ks_DBEdit->DataField="KS";

	// БИК
	Bik_DBEdit->DataSource=Clients_Datasource;
	Bik_DBEdit->DataField="BIK";

	// ОКНХ
	Okonh_DBEdit->DataSource=Clients_Datasource;
	Okonh_DBEdit->DataField="OKONH";

	// ОКПО
	Okpo_DBEdit->DataSource=Clients_Datasource;
	Okpo_DBEdit->DataField="OKPO";

	// ИНН
	Inn_DBEdit->DataSource=Clients_Datasource;
	Inn_DBEdit->DataField="INN";

	// Статус контактного лица
	Status_DBEdit->DataSource=Clients_Datasource;
	Status_DBEdit->DataField="STATUS";

	RadioButton3->Checked = false;
	RadioButton4->Checked = false;
	if (Clients_Datasource->DataSet->FieldByName("WHO")->AsInteger==1) {
		RadioButton3->Checked = true;
	}
	if (Clients_Datasource->DataSet->FieldByName("WHO")->AsInteger==3) {
		RadioButton4->Checked = true;
	}

}
//---------------------------------------------------------------------------
void __fastcall TFormKlientsKart::Button1Click(TObject *Sender)
{
	if (RadioButton3->Checked) {
		Clients_Datasource->DataSet->FieldByName("WHO")->AsInteger=1;
	}
	if (RadioButton4->Checked) {
		Clients_Datasource->DataSet->FieldByName("WHO")->AsInteger=3;
	}
	//Фиксация изменений
	Clients_Datasource->DataSet->CheckBrowseMode();
	//Записать изменения в базу данных
	//MainTransaction->Commit();
	MainTransaction->CommitRetaining();
	Close();
}
//---------------------------------------------------------------------------
void __fastcall TFormKlientsKart::Button2Click(TObject *Sender)
{
	Close();
}
//---------------------------------------------------------------------------
void __fastcall TFormKlientsKart::FormShow(TObject *Sender)
{
	RadioButton1->Checked = true;
	RadioButton2->Checked = false;
	this->Width = 349;
	//this->Width = 688

}
//---------------------------------------------------------------------------

void __fastcall TFormKlientsKart::RadioButton2Click(TObject *Sender)
{
	 // Информация юр. лица
	 RadioButton1->Checked = false;
	 RadioButton2->Checked = true;
	 this->Width = 688;
	 //Clients_Datasource_kategory->DataSet->Active=false;
	 Clients_Datasource_kategory->DataSet=Table_Clients_kategory2;
	 //Clients_Datasource_kategory->DataSet->Active=TRUE;
}
//---------------------------------------------------------------------------

void __fastcall TFormKlientsKart::RadioButton1Click(TObject *Sender)
{
	// Информация по клиенту
	RadioButton1->Checked = true;
	RadioButton2->Checked = false;
	this->Width = 349;
	//Clients_Datasource_kategory->DataSet->Active=false;
	Clients_Datasource_kategory->DataSet=Table_Clients_kategory1;
	//Clients_Datasource_kategory->DataSet->Active=TRUE;
}
//---------------------------------------------------------------------------

void __fastcall TFormKlientsKart::RadioButton3Click(TObject *Sender)
{
	RadioButton3->Checked = true;
	RadioButton4->Checked = false;
}
//---------------------------------------------------------------------------

void __fastcall TFormKlientsKart::RadioButton4Click(TObject *Sender)
{
	RadioButton4->Checked = true;
	RadioButton3->Checked = false;
}
//---------------------------------------------------------------------------

